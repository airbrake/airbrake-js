{"version":3,"file":"pg.js","sources":["../../src/instrumentation/pg.ts"],"sourcesContent":["import { Notifier } from '../notifier';\nimport { QueryInfo } from '../queries';\n\nconst SPAN_NAME = 'sql';\n\nexport function patch(pg, airbrake: Notifier): void {\n  patchClient(pg.Client, airbrake);\n\n  const origGetter = pg.__lookupGetter__('native');\n  if (origGetter) {\n    delete pg.native;\n    pg.__defineGetter__('native', () => {\n      const native = origGetter();\n      if (native && native.Client) {\n        patchClient(native.Client, airbrake);\n      }\n      return native;\n    });\n  }\n}\n\n// tslint:disable-next-line: variable-name\nfunction patchClient(Client, airbrake: Notifier): void {\n  const origQuery = Client.prototype.query;\n  Client.prototype.query = function abQuery(sql) {\n    const metric = airbrake.scope().routeMetric();\n    if (!metric.isRecording()) {\n      return origQuery.apply(this, arguments);\n    }\n    metric.startSpan(SPAN_NAME);\n\n    if (sql && typeof sql.text === 'string') {\n      sql = sql.text;\n    }\n\n    let qinfo: QueryInfo;\n    if (typeof sql === 'string') {\n      qinfo = airbrake.queries.start(sql);\n    }\n\n    let cbIdx = arguments.length - 1;\n    let cb = arguments[cbIdx];\n    if (Array.isArray(cb)) {\n      cbIdx = cb.length - 1;\n      cb = cb[cbIdx];\n    }\n\n    const endSpan = () => {\n      metric.endSpan(SPAN_NAME);\n      if (qinfo) {\n        airbrake.queries.notify(qinfo);\n      }\n    };\n\n    if (typeof cb === 'function') {\n      arguments[cbIdx] = function abCallback() {\n        endSpan();\n        return cb.apply(this, arguments);\n      };\n      return origQuery.apply(this, arguments);\n    }\n\n    const query = origQuery.apply(this, arguments);\n\n    if (typeof query.on === 'function') {\n      query.on('end', endSpan);\n      query.on('error', endSpan);\n    } else if (\n      typeof query.then === 'function' &&\n      typeof query.catch === 'function'\n    ) {\n      query.then(endSpan).catch(endSpan);\n    }\n\n    return query;\n  };\n}\n"],"names":[],"mappings":"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"}